<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Lecturas | Resultados y Tendencias (PWA)</title>

  <meta name="theme-color" content="#0b0f14" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

  <style>
    :root{
      --bg:#0b0f14;
      --card:#121a23;
      --card2:#0f1620;
      --stroke:#223043;
      --text:#f2f6ff;
      --muted:#aab6c6;
      --accent:#00e5ff;
      --ok:#00c853;
      --warn:#ffab00;
      --bad:#ff1744;
      --radius:18px;
      --shadow:0 10px 30px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:
        radial-gradient(1200px 800px at 20% -10%, rgba(0,229,255,.18), transparent 60%),
        radial-gradient(900px 700px at 80% 0%, rgba(0,200,83,.12), transparent 55%),
        var(--bg);
      color:var(--text);
    }
    a{color:inherit;text-decoration:none}
    .wrap{max-width:1100px;margin:auto;padding:18px 14px 30px}

    /* Topbar */
    .topbar{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:10px 12px;border:1px solid rgba(34,48,67,.7);
      border-radius:var(--radius);background:rgba(15,22,32,.75);backdrop-filter:blur(10px);
      position:relative;z-index:50
    }
    .brand{display:flex;align-items:center;gap:10px;min-width:0}
    .logo{
      width:38px;height:38px;border-radius:12px;
      background:linear-gradient(135deg, rgba(0,229,255,.25), rgba(0,200,83,.18));
      border:1px solid rgba(34,48,67,.8);display:grid;place-items:center;box-shadow:var(--shadow)
    }
    .brand .t strong{display:block;font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .brand .t span{display:block;font-size:12px;color:var(--muted);margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .actions{display:flex;gap:8px;align-items:center}
    .btn{
      border:1px solid rgba(34,48,67,.9);background:rgba(18,26,35,.85);color:var(--text);
      padding:10px 12px;border-radius:14px;font-weight:650;font-size:12px;cursor:pointer;box-shadow:0 10px 25px rgba(0,0,0,.25)
    }
    .btn.primary{border-color:rgba(0,229,255,.55);background:rgba(0,229,255,.10)}
    .btn.icon{width:40px;display:inline-flex;justify-content:center}

    /* Submenu */
    .menu{
      position:absolute;top:calc(100% + 10px);right:10px;width:280px;border-radius:16px;
      background:rgba(15,22,32,.92);border:1px solid rgba(34,48,67,.9);box-shadow:var(--shadow);
      display:none
    }
    .menu.open{display:block}
    .menu .hd{padding:12px;border-bottom:1px solid rgba(34,48,67,.7)}
    .menu .items{padding:10px;display:grid;gap:8px}
    .menu a.item{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:10px;border-radius:14px;border:1px solid rgba(34,48,67,.75);background:rgba(18,26,35,.55)
    }
    .menu a.item:hover{border-color:rgba(0,229,255,.35);background:rgba(0,229,255,.07)}

    /* Cards & layout */
    .hero{margin-top:14px;padding:16px;border-radius:var(--radius);border:1px solid rgba(34,48,67,.85);
      background:linear-gradient(180deg, rgba(0,229,255,.12), rgba(0,0,0,0)), rgba(15,22,32,.75);box-shadow:var(--shadow)}
    .hero h1{margin:0 0 10px;font-size:22px}
    .hero p{margin:0;color:var(--muted);line-height:1.55;font-size:13.5px}

    .grid{display:grid;gap:14px;margin-top:14px}
    @media(min-width:900px){.grid{grid-template-columns:1.2fr .8fr}}

    .card{border:1px solid rgba(34,48,67,.85);background:rgba(18,26,35,.75);
      border-radius:var(--radius);padding:16px;box-shadow:var(--shadow)}
    .card h2{margin:0 0 10px;font-size:16px}
    .card p{margin:0;color:var(--muted);line-height:1.55;font-size:13px}

    /* KPIs */
    .kpis{display:grid;gap:10px;margin-top:10px}
    @media(min-width:650px){.kpis{grid-template-columns:repeat(4,1fr)}}
    .kpi{border:1px solid rgba(34,48,67,.75);background:rgba(15,22,32,.65);border-radius:16px;padding:12px}
    .kpi .k{color:var(--muted);font-size:12px}
    .kpi .v{margin-top:6px;font-size:20px;font-weight:900;letter-spacing:-.3px;color:var(--accent)}
    .kpi .u{color:var(--muted);font-size:11.5px;margin-top:4px}

    /* Chart */
    .chartWrap{margin-top:10px;border:1px solid rgba(34,48,67,.75);background:rgba(15,22,32,.65);
      border-radius:16px;overflow:hidden}
    canvas{display:block;width:100%;height:240px}
    .chartBar{padding:10px 12px;border-top:1px solid rgba(34,48,67,.7);display:flex;justify-content:space-between;gap:10px;color:var(--muted);font-size:12px;flex-wrap:wrap}
    .seg{display:flex;gap:6px;align-items:center}
    .pillBtn{border:1px solid rgba(34,48,67,.75);background:rgba(18,26,35,.55);padding:8px 10px;border-radius:999px;font-size:12px;font-weight:700;cursor:pointer}
    .pillBtn.active{border-color:rgba(0,229,255,.55);background:rgba(0,229,255,.10)}

    /* Table */
    table{width:100%;border-collapse:separate;border-spacing:0;margin-top:10px;border-radius:16px;
      border:1px solid rgba(34,48,67,.75);background:rgba(15,22,32,.65);overflow:hidden}
    th,td{padding:10px;font-size:12px;color:var(--muted);border-bottom:1px solid rgba(34,48,67,.55)}
    th{color:rgba(242,246,255,.9);font-weight:800}
    tr:last-child td{border-bottom:none}

    /* Footer */
    .bottom{
      position:sticky;bottom:10px;margin-top:14px;border-radius:999px;padding:10px 12px;
      display:flex;justify-content:space-between;gap:12px;background:rgba(15,22,32,.75);
      border:1px solid rgba(34,48,67,.85);backdrop-filter:blur(10px);box-shadow:var(--shadow)
    }
    .dot{width:8px;height:8px;border-radius:99px;background:var(--warn)}
    .dot.ok{background:var(--ok)}
    .dot.bad{background:var(--bad)}
  </style>
  <link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#0b0f14">

</head>
<script>
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker.register("/service-worker.js")
        .then(reg => {
          console.log("Service Worker registrado:", reg.scope);
        })
        .catch(err => {
          console.error("SW error:", err);
        });
    });
  }
</script>

<body>
<div class="wrap">

  <!-- Topbar -->
  <div class="topbar">
    <div class="brand">
      <div class="logo" aria-hidden="true">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
          <path d="M13 2L4 14h7l-1 8 10-14h-7l0-6z" stroke="rgba(242,246,255,.9)" stroke-width="1.6"/>
        </svg>
      </div>
      <div class="t">
        <strong>Lecturas y Resultados</strong>
        <span>Histórico completo · Tendencias · Proyección</span>
      </div>
    </div>
    <div class="actions">
      <button class="btn" id="btnRefresh">Actualizar</button>
      <button class="btn icon" id="btnMenu">☰</button>
    </div>
    <div class="menu" id="menu">
      <div class="hd"><strong>Navegación</strong></div>
      <div class="items">
        <a class="item" href="./index.html">Inicio</a>
        <a class="item" href="./prediccion.html">Predicción</a>
        <a class="item" href="./lecturas.html" aria-current="page">Lecturas</a>
      </div>
    </div>
  </div>

  <div class="hero">
    <h1>Resultados del histórico de lecturas</h1>
    <p>
      Esta sección resume <b>todas las lecturas almacenadas en la base de datos</b>, muestra tendencias reales
      y presenta <b>predicciones estimadas</b> basadas en el comportamiento histórico completo.
    </p>
  </div>

  <div class="grid">
    <!-- Izquierda -->
    <div>
      <div class="card">
        <h2>Resumen global</h2>
        <div class="kpis">
          <div class="kpi"><div class="k">Lecturas cargadas</div><div class="v" id="kCount">—</div><div class="u">registros</div></div>
          <div class="kpi"><div class="k">Rango temporal</div><div class="v" id="kRange">—</div><div class="u">desde · hasta</div></div>
          <div class="kpi"><div class="k">Potencia promedio</div><div class="v" id="kPavg">—</div><div class="u">W</div></div>
          <div class="kpi"><div class="k">Consumo medio</div><div class="v" id="kKwh">—</div><div class="u">kWh/h</div></div>
        </div>
      </div>

      <div class="card">
        <h2>Tendencias y proyección</h2>
        <p>
          El gráfico muestra potencia promedio (W) y consumo horario estimado (kWh/h).
          La proyección se calcula como una extensión del perfil horario (baseline robusto).
        </p>
        <div class="chartWrap">
          <canvas id="chart" width="1000" height="240"></canvas>
          <div class="chartBar">
            <div class="seg">
              <button class="pillBtn active" data-range="24h" id="r24h">24h</button>
              <button class="pillBtn" data-range="7d" id="r7d">7d</button>
              <button class="pillBtn" data-range="30d" id="r30d">30d</button>
            </div>
            <div id="chartMeta">—</div>
          </div>
        </div>
      </div>

      <div class="card">
        <h2>Conclusiones automáticas</h2>
        <p id="conclusions">—</p>
      </div>
    </div>

    <!-- Derecha -->
    <div>
      <div class="card">
        <h2>Últimas lecturas</h2>
        <table>
          <thead><tr><th>Hora</th><th>V</th><th>I</th><th>P</th><th>E</th></tr></thead>
          <tbody id="tbl"><tr><td colspan="5">Esperando datos…</td></tr></tbody>
        </table>
      </div>

      <div class="card">
        <h2>Estado del sistema</h2>
        <p id="sysState">Inicializando…</p>
      </div>
    </div>
  </div>

  <div class="bottom">
    <div class="left"><span class="dot" id="dot"></span><span id="bottomText">Inicializando…</span></div>
    <div class="right">PWA Ready</div>
  </div>
</div>

<script>
  const API_BASE = "https://iot-backend-ynkx.onrender.com";
  const READ = "/api/readings?limit=5000";

  const el = (id)=>document.getElementById(id);
  const clamp=(n,a,b)=>Math.max(a,Math.min(b,n));

  function infer(r, keys){ for(const k of keys){ if(r[k]!=null) return Number(r[k]); } return null; }
  function inferTS(r){ const t=r.ts||r.timestamp||r.createdAt; const d=new Date(t); return Number.isFinite(d.getTime())?d.getTime():null; }

  function norm(r){
    const v=infer(r,["v","vrms","voltage"]);
    const i=infer(r,["i","irms","current"]);
    let p=infer(r,["p","p_w","power"]);
    if(!Number.isFinite(p)&&Number.isFinite(v)&&Number.isFinite(i)) p=v*i;
    let e=infer(r,["energy_kwh","kwh_total","e"]);
    if(!Number.isFinite(e)){ const wh=infer(r,["energy_wh","e_wh"]); if(Number.isFinite(wh)) e=wh/1000; }
    return { tsMs:inferTS(r), v,i,p,e };
  }

  function groupHour(arr){
    const m=new Map();
    for(const x of arr){
      const d=new Date(x.tsMs); const k=`${d.getFullYear()}-${d.getMonth()}-${d.getDate()}-${d.getHours()}`;
      if(!m.has(k)) m.set(k,{tsMs:new Date(d.setMinutes(0,0,0)).getTime(),n:0,pSum:0});
      const g=m.get(k); g.n++; if(Number.isFinite(x.p)) g.pSum+=x.p;
    }
    return Array.from(m.values()).map(g=>({tsMs:g.tsMs,pAvg:g.n?g.pSum/g.n:null,kwh_h:g.n?(g.pSum/g.n)/1000:null})).sort((a,b)=>a.tsMs-b.tsMs);
  }

  function draw(series){
    const c=el("chart"),ctx=c.getContext("2d"); ctx.clearRect(0,0,c.width,c.height);
    const pad=40,w=c.width-56,h=c.height-56;
    const xs=series.map(s=>s.tsMs), p=series.map(s=>s.pAvg), k=series.map(s=>s.kwh_h);
    if(xs.length<2) return;
    const x0=Math.min(...xs), x1=Math.max(...xs);
    const pMax=Math.max(1,...p.filter(Number.isFinite)), kMax=Math.max(0.001,...k.filter(Number.isFinite));
    const x=(t)=>pad+(t-x0)/(x1-x0)*w;
    const yP=(v)=>28+(1-(v/pMax))*h;
    const yK=(v)=>28+(1-(v/kMax))*h;

    ctx.strokeStyle="rgba(34,48,67,.9)"; ctx.strokeRect(1,1,c.width-2,c.height-2);
    ctx.strokeStyle="rgba(0,200,83,.9)"; ctx.lineWidth=2; ctx.beginPath();
    series.forEach((s,i)=>{ const X=x(s.tsMs),Y=yP(s.pAvg||0); if(i===0)ctx.moveTo(X,Y); else ctx.lineTo(X,Y); }); ctx.stroke();
    ctx.strokeStyle="rgba(255,171,0,.9)"; ctx.beginPath();
    series.forEach((s,i)=>{ const X=x(s.tsMs),Y=yK(s.kwh_h||0); if(i===0)ctx.moveTo(X,Y); else ctx.lineTo(X,Y); }); ctx.stroke();
  }

  function conclusions(arr){
    if(!arr.length) return "No hay datos suficientes.";
    const p=arr.map(x=>x.p).filter(Number.isFinite);
    const avg=p.reduce((a,b)=>a+b,0)/p.length;
    const max=Math.max(...p);
    return `El consumo muestra una potencia promedio de ${avg.toFixed(1)} W con picos de hasta ${max.toFixed(1)} W.
    Se recomienda revisar horarios pico y cargas predominantes para optimizar el consumo.`;
  }

  async function load(){
    el("bottomText").textContent="Cargando lecturas…";
    const r=await fetch(API_BASE+READ,{cache:"no-store"});
    const j=await r.json();
    const arr=(Array.isArray(j)?j:[]).map(norm).filter(x=>Number.isFinite(x.tsMs));
    arr.sort((a,b)=>a.tsMs-b.tsMs);

    el("kCount").textContent=arr.length;
    if(arr.length){
      el("kRange").textContent=new Date(arr[0].tsMs).toLocaleDateString()+" · "+new Date(arr[arr.length-1].tsMs).toLocaleDateString();
    }
    const pAvg=arr.map(x=>x.p).filter(Number.isFinite).reduce((a,b)=>a+b,0)/Math.max(1,arr.length);
    el("kPavg").textContent=isFinite(pAvg)?pAvg.toFixed(1):"—";
    const h=groupHour(arr); const kAvg=h.map(x=>x.kwh_h).filter(Number.isFinite).reduce((a,b)=>a+b,0)/Math.max(1,h.length);
    el("kKwh").textContent=isFinite(kAvg)?kAvg.toFixed(3):"—";

    draw(h);
    el("conclusions").textContent=conclusions(arr);

    const last=arr.slice(-8).reverse();
    el("tbl").innerHTML=last.map(x=>{
      const d=new Date(x.tsMs); const hh=String(d.getHours()).padStart(2,"0")+":"+String(d.getMinutes()).padStart(2,"0");
      return `<tr><td>${hh}</td><td>${x.v?.toFixed(1)||"—"}</td><td>${x.i?.toFixed(2)||"—"}</td><td>${x.p?.toFixed(1)||"—"}</td><td>${x.e?.toFixed(3)||"—"}</td></tr>`;
    }).join("");

    el("sysState").textContent="Lecturas cargadas correctamente.";
    el("dot").classList.add("ok");
    el("bottomText").textContent=`OK · Lecturas: ${arr.length}`;
  }

  el("btnRefresh").addEventListener("click", load);
  el("btnMenu").addEventListener("click", ()=>el("menu").classList.toggle("open"));
  load();
</script>
</body>
</html>
